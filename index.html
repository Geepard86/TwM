<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TwM - Tobi wird Million√§r</title>
    <style>
        :root {
            --primary: #e94560;
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --accent: #0f3460;
            --text: #ffffff;
            --danger: #ff4c4c;
            --success: #28a745;
        }

        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: var(--bg-dark); 
            color: var(--text); 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            min-height: 100vh;
            touch-action: manipulation;
        }

        .container { 
            width: 100%; max-width: 500px; padding: 20px; 
            background: var(--bg-card); min-height: 100vh;
            box-sizing: border-box; display: flex; flex-direction: column;
        }

        h1 { color: var(--primary); text-align: center; margin: 0; }
        .subtitle { text-align: center; opacity: 0.6; font-size: 0.8em; margin-bottom: 15px; }
        .hidden { display: none; }

        #sortableList { margin: 15px 0; }
        .option { 
            background: var(--accent); margin: 8px 0; padding: 15px; 
            border: 2px solid rgba(255,255,255,0.1); border-radius: 10px; 
            font-weight: bold; transition: opacity 0.2s;
        }

        .input-display {
            background: #000; padding: 15px; border-radius: 10px;
            text-align: center; font-size: 1.5em; letter-spacing: 10px;
            margin-bottom: 15px; color: var(--primary); min-height: 1.2em;
            border: 2px solid var(--accent); font-family: monospace;
        }
        .button-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px; }
        .choice-btn {
            background: var(--accent); color: white; border: none; padding: 15px 5px;
            border-radius: 8px; font-weight: bold; font-size: 1.2em; cursor: pointer;
        }
        .choice-btn:disabled { opacity: 0.2; cursor: default; }
        .choice-btn.backspace { background: #444; }

        button.main-btn { 
            width: 100%; background: var(--primary); color: white; border: none; 
            padding: 15px; border-radius: 10px; font-weight: bold; margin: 5px 0;
            cursor: pointer; font-size: 1rem;
        }
        button.secondary { background: #4e4e4e; }
        button.danger { background: var(--danger); }
        button:disabled { opacity: 0.5; }
        
        .stats-box { 
            background: rgba(0,0,0,0.3); padding: 15px; border-radius: 15px; 
            font-size: 0.9em; margin: 15px 0; border: 1px dashed var(--primary);
        }

        #timer { font-size: 2.5em; color: var(--primary); text-align: center; font-family: monospace; }
        
        input, textarea {
            width: 100%; padding: 12px; margin: 5px 0; border-radius: 8px; border: none;
            background: #0f3460; color: white; box-sizing: border-box; font-size: 1rem;
        }

        .feedback-area { margin-top: 15px; padding: 15px; border-radius: 10px; text-align: center; font-weight: bold; }
        .correct { background: var(--success); }
        .wrong { background: var(--danger); }
    </style>
</head>
<body>

<div class="container">
    <div id="menu">
        <h1>TwM üí∞</h1>
        <p class="subtitle">Tobi wird Million√§r - Selection Training</p>
        <div class="stats-box" id="mainStats">Lade Daten...</div>
        <button class="main-btn" onclick="startTraining()">Training starten</button>
        <button class="main-btn secondary" onclick="showView('addQuestionView')">Frage hinzuf√ºgen</button>
        <button class="main-btn secondary" onclick="showView('settingsView')">Settings ‚öôÔ∏è</button>
    </div>

    <div id="trainingView" class="hidden">
        <div id="timer">0.00s</div>
        <p id="questionText" style="text-align: center; font-weight: bold; min-height: 50px;"></p>
        <div id="sortableList"></div>
        <div class="input-display" id="userInputDisplay">____</div>
        <div class="button-grid">
            <button class="choice-btn" id="btnA" onclick="typeKey('A')">A</button>
            <button class="choice-btn" id="btnB" onclick="typeKey('B')">B</button>
            <button class="choice-btn" id="btnC" onclick="typeKey('C')">C</button>
            <button class="choice-btn" id="btnD" onclick="typeKey('D')">D</button>
            <button class="choice-btn backspace" onclick="backspace()">‚å´</button>
        </div>
        <button id="lockBtn" class="main-btn" onclick="checkAnswer()" disabled>Einloggen</button>
        <div id="result" class="hidden">
            <div id="feedback" class="feedback-area"></div>
            <p id="explanation" style="margin-top: 10px; font-style: italic; text-align: center; font-size: 0.9em;"></p>
            <button class="main-btn" onclick="nextQuestion()">N√§chste Frage</button>
            <button class="main-btn secondary" onclick="showView('menu')">Beenden</button>
        </div>
    </div>

    <div id="addQuestionView" class="hidden">
        <h3>Neue Frage</h3>
        <input type="text" id="qText" placeholder="Fragestellung" class="nav-input">
        <input type="text" id="optA" placeholder="Option A" class="nav-input">
        <input type="text" id="optB" placeholder="Option B" class="nav-input">
        <input type="text" id="optC" placeholder="Option C" class="nav-input">
        <input type="text" id="optD" placeholder="Option D" class="nav-input">
        <input type="text" id="correctOrder" placeholder="Reihenfolge (z.B. BADC)" maxlength="4" class="nav-input" autocomplete="off" style="text-transform: uppercase; font-weight: bold;">
        <textarea id="qExpl" placeholder="Erkl√§rung (optional)" class="nav-input"></textarea>
        <button class="main-btn" onclick="saveQuestion()">Speichern (Enter)</button>
        <button class="main-btn secondary" onclick="showView('menu')">Abbrechen</button>
    </div>

    <div id="settingsView" class="hidden">
        <h3>Settings ‚öôÔ∏è</h3>
        <button class="main-btn secondary" onclick="exportData()">üì¶ Daten Exportieren (fragen.json)</button>
        <button class="main-btn secondary" onclick="resetRemoteData()">üóëÔ∏è NPoint Cloud LEEREN</button>
        <button class="main-btn danger" onclick="resetStatistics()">üìâ Statistik Reset</button>
        <button class="main-btn" onclick="showView('menu')">Zur√ºck</button>
    </div>
</div>

<script>
    const NPOINT_ID = 'ab726626f0cb39e63663'; 
    let questions = [];
    let stats = { total: 0, correct: 0, avgSpeed: 0 };
    let currentQuestion = null;
    let startTime;
    let timerInterval;
    let currentInput = "";

    async function loadData() {
        try {
            const localRes = await fetch('fragen.json');
            const localData = await localRes.json();
            questions = localData.questions || [];
            stats = localData.stats || { total: 0, correct: 0, avgSpeed: 0 };

            const remoteRes = await fetch(`https://api.npoint.io/${NPOINT_ID}`);
            if (remoteRes.ok) {
                const remoteData = await remoteRes.json();
                if (remoteData.questions) {
                    remoteData.questions.forEach(rq => {
                        if (!questions.find(lq => lq.text === rq.text)) questions.push(rq);
                    });
                }
                if (remoteData.stats && remoteData.stats.total > stats.total) stats = remoteData.stats;
            }
            updateStatsDisplay();
        } catch (e) { console.warn("Daten werden geladen..."); }
    }

    function updateStatsDisplay() {
        const percent = stats.total > 0 ? Math.round((stats.correct / stats.total) * 100) : 0;
        document.getElementById('mainStats').innerHTML = `Fragen: ${stats.total} | Richtig: ${percent}% | √ò ${stats.avgSpeed.toFixed(2)}s`;
    }

    function showView(id) {
        document.querySelectorAll('.container > div').forEach(div => div.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function startTraining() {
        if(questions.length === 0) return alert("Keine Fragen geladen.");
        showView('trainingView');
        nextQuestion();
    }

    function nextQuestion() {
        document.getElementById('result').classList.add('hidden');
        document.getElementById('lockBtn').classList.remove('hidden');
        currentInput = "";
        updateInputUI();
        currentQuestion = questions[Math.floor(Math.random() * questions.length)];
        document.getElementById('questionText').innerText = currentQuestion.text;
        const list = document.getElementById('sortableList');
        list.innerHTML = '';
        ['A', 'B', 'C', 'D'].forEach(key => {
            const div = document.createElement('div');
            div.className = 'option';
            div.id = `opt-${key}`;
            div.innerText = `${key}: ${currentQuestion.options[key]}`;
            list.appendChild(div);
        });
        startTime = Date.now();
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            document.getElementById('timer').innerText = ((Date.now() - startTime) / 1000).toFixed(2) + "s";
        }, 50);
    }

    function typeKey(key) {
        if (currentInput.length < 4 && !currentInput.includes(key)) {
            currentInput += key;
            updateInputUI();
        }
    }

    function backspace() {
        currentInput = currentInput.slice(0, -1);
        updateInputUI();
    }

    function updateInputUI() {
        document.getElementById('userInputDisplay').innerText = currentInput.padEnd(4, "_");
        ['A', 'B', 'C', 'D'].forEach(key => {
            document.getElementById(`btn${key}`).disabled = currentInput.includes(key);
            const optEl = document.getElementById(`opt-${key}`);
            if(optEl) optEl.style.opacity = currentInput.includes(key) ? "0.2" : "1";
        });
        document.getElementById('lockBtn').disabled = (currentInput.length < 4);
    }

    function checkAnswer() {
        clearInterval(timerInterval);
        const endTime = (Date.now() - startTime) / 1000;
        const correct = currentInput === currentQuestion.answer;
        stats.total++;
        if (correct) stats.correct++;
        stats.avgSpeed = (stats.avgSpeed * (stats.total - 1) + endTime) / stats.total;
        const fb = document.getElementById('feedback');
        fb.className = 'feedback-area ' + (correct ? 'correct' : 'wrong');
        fb.innerText = correct ? `RICHTIG! ‚úÖ (${endTime.toFixed(2)}s)` : `FALSCH! ‚ùå Korrekt: ${currentQuestion.answer}`;
        document.getElementById('explanation').innerText = currentQuestion.explanation || "";
        document.getElementById('result').classList.remove('hidden');
        document.getElementById('lockBtn').classList.add('hidden');
        updateStatsDisplay();
        saveToNpoint();
    }

    async function saveToNpoint() {
        await fetch(`https://api.npoint.io/${NPOINT_ID}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ questions, stats })
        });
    }

    function exportData() {
        // Hier war die fehlende Klammer im alten Code:
        const data = { 
            questions: questions, 
            stats: { total: 0, correct: 0, avgSpeed: 0 } 
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'fragen.json';
        a.click();
    }

    async function resetRemoteData() {
        if (confirm("Cloud (npoint) wirklich LEEREN?")) {
            const emptyData = { questions: [], stats: { total: 0, correct: 0, avgSpeed: 0 } };
            await fetch(`https://api.npoint.io/${NPOINT_ID}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(emptyData)
            });
            alert("Cloud geleert!");
            location.reload();
        }
    }

    async function resetStatistics() {
        if (confirm("Statistik auf Null setzen?")) {
            stats = { total: 0, correct: 0, avgSpeed: 0 };
            updateStatsDisplay();
            await saveToNpoint();
        }
    }

    async function saveQuestion() {
        const newQ = {
            text: document.getElementById('qText').value,
            options: { 
                A: document.getElementById('optA').value, 
                B: document.getElementById('optB').value, 
                C: document.getElementById('optC').value, 
                D: document.getElementById('optD').value 
            },
            answer: document.getElementById('correctOrder').value.toUpperCase(),
            explanation: document.getElementById('qExpl').value
        };
        if(!newQ.text || newQ.answer.length < 4) return alert("Bitte alles ausf√ºllen!");
        questions.push(newQ);
        await saveToNpoint();
        alert("Gespeichert!");
        showView('menu');
        document.querySelectorAll('.nav-input').forEach(i => i.value = "");
    }

    // Enter Navigation
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            const active = document.activeElement;
            if (active.classList.contains('nav-input')) {
                e.preventDefault();
                const inputs = Array.from(document.querySelectorAll('.nav-input'));
                const index = inputs.indexOf(active);
                if (index < inputs.length - 1) inputs[index + 1].focus();
                else saveQuestion();
            }
        }
    });

    document.getElementById('correctOrder').addEventListener('input', function() {
        this.value = this.value.toUpperCase().replace(/[^A-D]/g, '');
    });

    loadData();
</script>
</body>
</html>
