<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TwM - Tobi wird Million√§r</title>
    <style>
        :root {
            --primary: #e94560;
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --accent: #0f3460;
            --text: #ffffff;
            --danger: #ff4c4c;
        }

        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: var(--bg-dark); 
            color: var(--text); 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            min-height: 100vh;
            touch-action: manipulation;
        }

        .container { 
            width: 100%; 
            max-width: 500px; 
            padding: 20px; 
            background: var(--bg-card); 
            min-height: 100vh;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        h1 { color: var(--primary); text-align: center; margin-bottom: 5px; }
        .subtitle { text-align: center; opacity: 0.6; font-size: 0.8em; margin-bottom: 20px; }
        .hidden { display: none; }

        /* Optionen / Sortierung */
        #sortableList { margin: 20px 0; }
        .option { 
            background: var(--accent); 
            margin: 10px 0; 
            padding: 18px; 
            cursor: grab; 
            border: 2px solid rgba(255,255,255,0.1); 
            border-radius: 12px; 
            user-select: none;
            touch-action: none;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .option.dragging { 
            opacity: 0.9; 
            transform: scale(1.02);
            background: var(--primary);
            border-color: white;
        }

        /* Buttons */
        button { 
            width: 100%;
            background: var(--primary); 
            color: white; 
            border: none; 
            padding: 15px; 
            cursor: pointer; 
            border-radius: 10px; 
            font-weight: bold; 
            margin: 8px 0;
            font-size: 1rem;
        }
        button.secondary { background: #4e4e4e; }
        button.danger { background: var(--danger); }
        
        .stats-box { 
            background: rgba(0,0,0,0.3); 
            padding: 20px; 
            border-radius: 15px; 
            font-size: 0.95em; 
            margin: 20px 0;
            line-height: 1.6;
            border: 1px dashed var(--primary);
        }

        #timer { font-size: 3em; color: var(--primary); text-align: center; font-family: monospace; margin-bottom: 10px; }
        
        input, textarea {
            width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: none;
            background: #0f3460; color: white; box-sizing: border-box;
        }

        .feedback-area { margin-top: 20px; padding: 20px; border-radius: 10px; text-align: center; font-weight: bold; font-size: 1.2em; }
        .correct { background: #28a745; }
        .wrong { background: #dc3545; }

        .settings-group { margin-bottom: 30px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px; }
        .settings-label { display: block; margin-bottom: 10px; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <div id="menu">
        <h1>TwM üí∞</h1>
        <p class="subtitle">Tobi wird Million√§r - Selection Training</p>
        
        <div class="stats-box" id="mainStats">Lade Daten...</div>

        <button onclick="startTraining()">Training starten</button>
        <button onclick="showView('addQuestionView')" class="secondary">Frage hinzuf√ºgen</button>
        <button onclick="showView('settingsView')" class="secondary">Settings ‚öôÔ∏è</button>
    </div>

    <div id="trainingView" class="hidden">
        <div id="timer">0.00s</div>
        <h3 id="questionText" style="text-align: center; min-height: 60px;"></h3>
        <div id="sortableList"></div>
        <button id="lockBtn" onclick="checkAnswer()">Einloggen</button>
        
        <div id="result" class="hidden">
            <div id="feedback" class="feedback-area"></div>
            <p id="explanation" style="margin-top: 15px; font-style: italic; text-align: center;"></p>
            <button onclick="nextQuestion()">N√§chste Frage</button>
            <button onclick="showView('menu')" class="secondary">Beenden</button>
        </div>
    </div>

    <div id="addQuestionView" class="hidden">
        <h3>Neue Frage erstellen</h3>
        <input type="text" id="qText" placeholder="Fragestellung">
        <input type="text" id="optA" placeholder="Option A">
        <input type="text" id="optB" placeholder="Option B">
        <input type="text" id="optC" placeholder="Option C">
        <input type="text" id="optD" placeholder="Option D">
        <input type="text" id="correctOrder" placeholder="Korrekt (z.B. BADC)">
        <textarea id="qExpl" placeholder="Erkl√§rung (optional)"></textarea>
        <button onclick="saveQuestion()">Speichern & Upload</button>
        <button onclick="showView('menu')" class="secondary">Abbrechen</button>
    </div>

    <div id="settingsView" class="hidden">
        <h3>Settings ‚öôÔ∏è</h3>
        
        <div class="settings-group">
            <span class="settings-label">Daten-Management</span>
            <button onclick="exportData()" class="secondary">üì¶ Daten Exportieren (JSON)</button>
            <button onclick="resetRemoteData()" class="secondary">üîÑ NPoint Sync (Upload)</button>
        </div>

        <div class="settings-group">
            <span class="settings-label">Gefahrenzone</span>
            <button onclick="resetStatistics()" class="danger">üìâ Statistik Reset</button>
        </div>

        <button onclick="showView('menu')">Zur√ºck zum Hauptmen√º</button>
    </div>
</div>

<script>
    const NPOINT_ID = 'ab726626f0cb39e63663'; 
    let questions = [];
    let stats = { total: 0, correct: 0, avgSpeed: 0 };
    let currentQuestion = null;
    let startTime;
    let timerInterval;

    async function loadData() {
        try {
            const localRes = await fetch('fragen.json');
            const localData = await localRes.json();
            questions = localData.questions || [];
            stats = localData.stats || { total: 0, correct: 0, avgSpeed: 0 };

            const remoteRes = await fetch(`https://api.npoint.io/${NPOINT_ID}`);
            if (remoteRes.ok) {
                const remoteData = await remoteRes.json();
                if (remoteData.questions) {
                    remoteData.questions.forEach(rq => {
                        if (!questions.find(lq => lq.text === rq.text)) questions.push(rq);
                    });
                }
                if (remoteData.stats && remoteData.stats.total > stats.total) stats = remoteData.stats;
            }
            updateStatsDisplay();
        } catch (e) { 
            console.error(e);
            document.getElementById('mainStats').innerText = "Bereit (Lokale Daten verwendet)";
        }
    }

    function updateStatsDisplay() {
        const percent = stats.total > 0 ? Math.round((stats.correct / stats.total) * 100) : 0;
        document.getElementById('mainStats').innerHTML = `
            <b>Dein Fortschritt:</b><br>
            Beantwortet: <b>${stats.total}</b><br>
            Richtig: <b>${stats.correct}</b> (${percent}%)<br>
            √ò Zeit: <b>${stats.avgSpeed.toFixed(2)}s</b>
        `;
    }

    function showView(id) {
        document.querySelectorAll('.container > div').forEach(div => div.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function startTraining() {
        if (questions.length === 0) return alert("Lade erst Fragen!");
        showView('trainingView');
        nextQuestion();
    }

    function nextQuestion() {
        document.getElementById('result').classList.add('hidden');
        document.getElementById('lockBtn').classList.remove('hidden');
        currentQuestion = questions[Math.floor(Math.random() * questions.length)];
        document.getElementById('questionText').innerText = currentQuestion.text;
        
        const list = document.getElementById('sortableList');
        list.innerHTML = '';
        ['A', 'B', 'C', 'D'].sort(() => Math.random() - 0.5).forEach(key => {
            const div = document.createElement('div');
            div.className = 'option';
            div.innerText = `${key}: ${currentQuestion.options[key]}`;
            div.dataset.key = key;
            list.appendChild(div);
            addDragListeners(div);
        });
        
        startTime = Date.now();
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            document.getElementById('timer').innerText = ((Date.now() - startTime) / 1000).toFixed(2) + "s";
        }, 50);
    }

    function checkAnswer() {
        clearInterval(timerInterval);
        const endTime = (Date.now() - startTime) / 1000;
        const userOrder = Array.from(document.querySelectorAll('.option')).map(el => el.dataset.key).join('');
        const correct = userOrder === currentQuestion.answer;

        stats.total++;
        if (correct) stats.correct++;
        stats.avgSpeed = (stats.avgSpeed * (stats.total - 1) + endTime) / stats.total;

        const fb = document.getElementById('feedback');
        fb.className = 'feedback-area ' + (correct ? 'correct' : 'wrong');
        fb.innerText = correct ? `RICHTIG! ‚úÖ ${endTime.toFixed(2)}s` : `FALSCH! ‚ùå Korrekt: ${currentQuestion.answer}`;
        document.getElementById('explanation').innerText = currentQuestion.explanation || "";
        
        document.getElementById('result').classList.remove('hidden');
        document.getElementById('lockBtn').classList.add('hidden');
        updateStatsDisplay();
        saveToNpoint();
    }

    async function saveToNpoint() {
        try {
            await fetch(`https://api.npoint.io/${NPOINT_ID}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ questions, stats })
            });
        } catch (e) { console.warn("Sync failed"); }
    }

    function exportData() {
        const data = { questions, stats };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'twm_backup.json';
        a.click();
    }

    async function resetRemoteData() {
        if (confirm("M√∂chtest du npoint.io mit dem aktuellen lokalen Stand (Fragen & Stats) √ºberschreiben?")) {
            await saveToNpoint();
            alert("Erfolgreich synchronisiert!");
        }
    }

    async function resetStatistics() {
        if (confirm("Statistiken wirklich auf NULL setzen? Die Fragen bleiben erhalten.")) {
            stats = { total: 0, correct: 0, avgSpeed: 0 };
            updateStatsDisplay();
            await saveToNpoint();
            alert("Statistik wurde zur√ºckgesetzt.");
        }
    }

    async function saveQuestion() {
        const newQ = {
            text: document.getElementById('qText').value,
            options: {
                A: document.getElementById('optA').value,
                B: document.getElementById('optB').value,
                C: document.getElementById('optC').value,
                D: document.getElementById('optD').value
            },
            answer: document.getElementById('correctOrder').value.toUpperCase(),
            explanation: document.getElementById('qExpl').value
        };
        if(!newQ.text || !newQ.answer) return alert("Bitte Pflichtfelder ausf√ºllen!");
        questions.push(newQ);
        await saveToNpoint();
        showView('menu');
    }

    function addDragListeners(el) {
        el.onpointerdown = function(e) {
            el.classList.add('dragging');
            el.setPointerCapture(e.pointerId);
        };
        el.onpointermove = function(e) {
            if (!el.classList.contains('dragging')) return;
            const list = document.getElementById('sortableList');
            const afterElement = getDragAfterElement(list, e.clientY);
            if (afterElement == null) list.appendChild(el);
            else list.insertBefore(el, afterElement);
        };
        el.onpointerup = function() {
            el.classList.remove('dragging');
        };
    }

    function getDragAfterElement(container, y) {
        const elements = [...container.querySelectorAll('.option:not(.dragging)')];
        return elements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
            else return closest;
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    loadData();
</script>
</body>
</html>
