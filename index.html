<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TwM - Tobi wird Million√§r</title>
    <style>
        :root {
            --primary: #e94560;
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --accent: #0f3460;
            --text: #ffffff;
            --danger: #ff4c4c;
            --success: #28a745;
        }

        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: var(--bg-dark); 
            color: var(--text); 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
        }

        .container { 
            width: 100%; max-width: 500px; padding: 20px; 
            background: var(--bg-card); height: 100vh;
            box-sizing: border-box; position: relative;
        }

        /* View-Steuerung */
        .view {
            display: none; /* Standardm√§√üig alles weg */
            flex-direction: column;
            height: 100%;
            justify-content: space-between;
        }
        .view.active {
            display: flex; /* Nur die aktive View ist ein Flex-Container */
        }

        h1 { color: var(--primary); text-align: center; margin: 0; }
        .subtitle { text-align: center; opacity: 0.6; font-size: 0.8em; margin-bottom: 10px; }

        /* Training Layout */
        #questionText { text-align: center; font-weight: bold; margin: 10px 0; min-height: 3em; }
        #sortableList { flex-grow: 1; overflow-y: auto; margin-bottom: 10px; }
        
        .option { 
            background: var(--accent); margin: 6px 0; padding: 12px; 
            border: 2px solid rgba(255,255,255,0.1); border-radius: 10px; 
            font-weight: bold;
        }

        .input-display {
            background: #000; padding: 10px; border-radius: 10px;
            text-align: center; font-size: 1.8em; letter-spacing: 8px;
            margin-bottom: 10px; color: var(--primary); font-family: monospace;
            border: 2px solid var(--accent);
        }

        .button-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 10px; }
        .choice-btn {
            background: var(--accent); color: white; border: none; padding: 12px 0;
            border-radius: 8px; font-weight: bold; font-size: 1.2em; cursor: pointer;
        }
        .choice-btn:disabled { opacity: 0.2; }

        /* Buttons & Stats */
        button.main-btn { 
            width: 100%; background: var(--primary); color: white; border: none; 
            padding: 15px; border-radius: 10px; font-weight: bold; margin: 4px 0;
            cursor: pointer; font-size: 1rem;
        }
        button.secondary { background: #4e4e4e; }
        button.danger { background: var(--danger); }
        
        .stats-box { 
            background: rgba(0,0,0,0.3); padding: 15px; border-radius: 15px; 
            font-size: 0.85em; margin: 10px 0; border: 1px dashed var(--primary);
        }

        #timer { font-size: 2.5em; color: var(--primary); text-align: center; font-family: monospace; margin-bottom: 5px; }
        
        .explanation-box {
            padding: 12px; background: rgba(233, 69, 96, 0.1);
            border-left: 4px solid var(--primary); border-radius: 5px;
            font-style: italic; font-size: 0.85em; color: #ddd; margin-bottom: 10px;
            overflow-y: auto; max-height: 150px;
        }

        input, textarea {
            width: 100%; padding: 12px; margin: 5px 0; border-radius: 8px; border: none;
            background: #0f3460; color: white; box-sizing: border-box;
        }

        .feedback-area { padding: 12px; border-radius: 10px; text-align: center; font-weight: bold; margin-bottom: 10px; }
        .correct { background: var(--success); }
        .wrong { background: var(--danger); }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container">
    <div id="menu" class="view active">
        <div>
            <h1>TwM üí∞</h1>
            <p class="subtitle">Tobi wird Million√§r - Training</p>
            <div class="stats-box" id="mainStats">Lade Daten...</div>
        </div>
        <div>
            <button class="main-btn" onclick="startTraining()">Training starten</button>
            <button class="main-btn secondary" onclick="showView('addQuestionView')">Frage hinzuf√ºgen</button>
            <button class="main-btn secondary" onclick="showView('settingsView')">Settings ‚öôÔ∏è</button>
        </div>
    </div>

    <div id="trainingView" class="view">
        <div id="timer">0.00s</div>
        <p id="questionText"></p>
        
        <div id="sortableList"></div>

        <div id="interactionArea">
            <div class="input-display" id="userInputDisplay">____</div>
            <div class="button-grid">
                <button class="choice-btn" id="btnA" onclick="typeKey('A')">A</button>
                <button class="choice-btn" id="btnB" onclick="typeKey('B')">B</button>
                <button class="choice-btn" id="btnC" onclick="typeKey('C')">C</button>
                <button class="choice-btn" id="btnD" onclick="typeKey('D')">D</button>
                <button class="choice-btn" style="background:#444" onclick="backspace()">‚å´</button>
            </div>
            <button id="lockBtn" class="main-btn" onclick="checkAnswer()" disabled>Einloggen</button>
        </div>

        <div id="result" class="hidden">
            <div id="feedback" class="feedback-area"></div>
            <div class="explanation-box">
                <b>Erkl√§rung:</b><br><span id="explanation"></span>
            </div>
            <button class="main-btn" onclick="nextQuestion()">N√§chste Frage</button>
            <button class="main-btn secondary" onclick="showView('menu')">Beenden</button>
        </div>
    </div>

<div id="addQuestionView" class="view">
    <h1 id="addTitle">Frage hinzuf√ºgen</h1>
    
    <div style="flex-grow: 1; overflow-y: auto; padding: 10px 0;">
        <div id="singleInputFields">
            <input type="text" id="qText" placeholder="Fragestellung" class="nav-input">
            <input type="text" id="optA" placeholder="Option A" class="nav-input">
            <input type="text" id="optB" placeholder="Option B" class="nav-input">
            <input type="text" id="optC" placeholder="Option C" class="nav-input">
            <input type="text" id="optD" placeholder="Option D" class="nav-input">
            <input type="text" id="correctOrder" placeholder="Reihenfolge (z.B. BADC)" maxlength="4" class="nav-input" style="text-transform:uppercase">
            <textarea id="qExpl" placeholder="Erkl√§rung (optional)" class="nav-input" rows="3"></textarea>
            <button class="main-btn" onclick="saveQuestion()">Speichern (Enter)</button>
            <button class="main-btn secondary" onclick="toggleMassMode(true)">Zu Massenimport wechseln</button>
        </div>

        <div id="massInputFields" class="hidden">
            <div style="background: rgba(0,0,0,0.2); padding:10px; border-radius:8px; font-size:0.75em; margin-bottom:10px;">
                <strong>Format:</strong> Frage, dann A: B: C: D:, dann KORREKTE REIHENFOLGE: und ERKL√ÑRUNG:. Eine Leerzeile zwischen Fragen.
            </div>
            <textarea id="massInput" placeholder="Fragen hier einf√ºgen..." rows="10"></textarea>
            
            <div id="importPreview" class="hidden" style="background: #000; padding: 10px; border-radius: 5px; font-size: 0.8em; margin: 10px 0; max-height: 120px; overflow-y: auto; border: 1px solid var(--primary);">
                <div id="previewContent"></div>
            </div>

            <button id="previewBtn" class="main-btn" onclick="prepareImport()">Vorschau generieren</button>
            <div style="display: flex; gap: 10px;">
                <button id="confirmImportBtn" class="main-btn hidden" style="background:var(--success); flex: 2;" onclick="executeImport()">Import Best√§tigen</button>
                <button id="cancelImportBtn" class="main-btn danger hidden" style="flex: 1;" onclick="cancelImport()">Abbrechen</button>
            </div>
            <button class="main-btn secondary" onclick="toggleMassMode(false)">Zur√ºck zur Einzel-Eingabe</button>
        </div>
    </div>

    <button class="main-btn" onclick="closeAddView()">Abbrechen & Zur√ºck</button>
</div>

    <div id="settingsView" class="view">
        <h1>Settings ‚öôÔ∏è</h1>
        
        <div style="flex-grow: 1; display: flex; flex-direction: column; gap: 10px;">
            <p class="subtitle" style="margin-top: 20px;">Daten & Archivierung</p>
            <button class="main-btn secondary" onclick="exportData()">üì¶ Daten Exportieren (fragen.json)</button>
            
            <p class="subtitle" style="margin-top: 20px;">Gefahrenzone</p>
            <button class="main-btn secondary" onclick="resetRemoteData()">üóëÔ∏è NPoint Cloud LEEREN</button>
            <button class="main-btn danger" onclick="resetStatistics()">üìâ Statistik Reset</button>
        </div>

        <button class="main-btn" onclick="showView('menu')">Zur√ºck</button>
    </div>
</div>

<script>
    const NPOINT_ID = 'ab726626f0cb39e63663'; 
    let questions = [], stats = { total: 0, correct: 0, avgSpeed: 0 };
    let availableQuestions = [], currentQuestion = null;
    let startTime, timerInterval, currentInput = "";

    async function loadData() {
        try {
            const localRes = await fetch('fragen.json');
            if(localRes.ok) {
                const localData = await localRes.json();
                questions = localData.questions || [];
                stats = localData.stats || { total: 0, correct: 0, avgSpeed: 0 };
            }
            const remoteRes = await fetch(`https://api.npoint.io/${NPOINT_ID}`);
            if (remoteRes.ok) {
                const remoteData = await remoteRes.json();
                if (remoteData.questions) {
                    remoteData.questions.forEach(rq => {
                        if (!questions.find(lq => lq.text === rq.text)) questions.push(rq);
                    });
                }
                if (remoteData.stats && remoteData.stats.total > stats.total) stats = remoteData.stats;
            }
            availableQuestions = [...questions];
            updateStatsDisplay();
        } catch (e) { console.error("Load Error", e); }
    }

    function updateStatsDisplay() {
        const percent = stats.total > 0 ? Math.round((stats.correct / stats.total) * 100) : 0;
        const remaining = availableQuestions.length;
        document.getElementById('mainStats').innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                <span>Pool: <b>${questions.length}</b></span>
                <span>Gespielt: <b>${stats.total}</b></span>
                <span>Richtig: <b>${percent}%</b></span>
                <span>√ò Speed: <b>${stats.avgSpeed.toFixed(2)}s</b></span>
            </div>
            <hr style="border:0; border-top:1px solid #0f3460; margin:10px 0">
            <div style="text-align:center">Noch <b>${remaining}</b> neue Fragen im Topf</div>`;
    }

    function showView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        updateStatsDisplay();
    }

    function startTraining() {
        if(questions.length === 0) return alert("Keine Fragen!");
        // Falls der Topf leer ist (z.B. nach dem Laden oder Reset), f√ºllen:
    if (availableQuestions.length === 0) {
        availableQuestions = [...questions];
    }
        showView('trainingView');
        nextQuestion();
    }

    function nextQuestion() {
        document.getElementById('result').classList.add('hidden');
        document.getElementById('interactionArea').classList.remove('hidden');
        currentInput = "";
        updateInputUI();

        if (availableQuestions.length === 0) availableQuestions = [...questions];
        const idx = Math.floor(Math.random() * availableQuestions.length);
        currentQuestion = availableQuestions.splice(idx, 1)[0];

        document.getElementById('questionText').innerText = currentQuestion.text;
        const list = document.getElementById('sortableList');
        list.innerHTML = '';
        ['A', 'B', 'C', 'D'].forEach(key => {
            const div = document.createElement('div');
            div.className = 'option';
            div.id = `opt-${key}`;
            div.innerText = `${key}: ${currentQuestion.options[key]}`;
            list.appendChild(div);
        });

        startTime = Date.now();
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            document.getElementById('timer').innerText = ((Date.now() - startTime) / 1000).toFixed(2) + "s";
        }, 50);
    }

    function typeKey(key) {
        if (currentInput.length < 4 && !currentInput.includes(key)) {
            currentInput += key;
            updateInputUI();
        }
    }

    function backspace() {
        currentInput = currentInput.slice(0, -1);
        updateInputUI();
    }

    function updateInputUI() {
        document.getElementById('userInputDisplay').innerText = currentInput.padEnd(4, "_");
        ['A', 'B', 'C', 'D'].forEach(k => {
            document.getElementById(`btn${k}`).disabled = currentInput.includes(k);
            const el = document.getElementById(`opt-${k}`);
            if(el) el.style.opacity = currentInput.includes(k) ? "0.2" : "1";
        });
        document.getElementById('lockBtn').disabled = (currentInput.length < 4);
    }

    function checkAnswer() {
        clearInterval(timerInterval);
        const time = (Date.now() - startTime) / 1000;
        const correct = currentInput === currentQuestion.answer;
        stats.total++;
        if (correct) stats.correct++;
        stats.avgSpeed = (stats.avgSpeed * (stats.total - 1) + time) / stats.total;

        document.getElementById('interactionArea').classList.add('hidden');
        const fb = document.getElementById('feedback');
        fb.className = 'feedback-area ' + (correct ? 'correct' : 'wrong');
        fb.innerText = correct ? `RICHTIG! ‚úÖ (${time.toFixed(2)}s)` : `FALSCH! ‚ùå Korrekt: ${currentQuestion.answer}`;
        document.getElementById('explanation').innerText = currentQuestion.explanation || "Keine Erkl√§rung vorhanden.";
        document.getElementById('result').classList.remove('hidden');
        saveToNpoint();
    }

    async function saveToNpoint() {
        await fetch(`https://api.npoint.io/${NPOINT_ID}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ questions, stats })
        });
    }

    function exportData() {
        const data = { questions, stats: { total: 0, correct: 0, avgSpeed: 0 } };
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }));
        a.download = 'fragen.json';
        a.click();
    }

    async function resetRemoteData() {
        if (confirm("Cloud wirklich LEEREN?")) {
            await fetch(`https://api.npoint.io/${NPOINT_ID}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ questions: [], stats: { total: 0, correct: 0, avgSpeed: 0 } })
            });
            location.reload();
        }
    }

    async function resetStatistics() {
        if (confirm("Statistik Reset?")) {
            stats = { total: 0, correct: 0, avgSpeed: 0 };
            availableQuestions = [...questions];
            updateStatsDisplay();
            saveToNpoint();
        }
    }

    async function saveQuestion() {
        const newQ = {
            text: document.getElementById('qText').value,
            options: { A: document.getElementById('optA').value, B: document.getElementById('optB').value, C: document.getElementById('optC').value, D: document.getElementById('optD').value },
            answer: document.getElementById('correctOrder').value.toUpperCase(),
            explanation: document.getElementById('qExpl').value
        };
        if(!newQ.text || newQ.answer.length < 4) return alert("Fehler!");
        questions.push(newQ);
        await saveToNpoint();
        showView('menu');
        document.querySelectorAll('.nav-input').forEach(i => i.value = "");
    }

// --- INPUT VALIDIERUNG & NAVIGATION ---

// 1. Navigation mit Enter-Taste
document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        const active = document.activeElement;
        if (active.classList.contains('nav-input')) {
            e.preventDefault();
            const inputs = Array.from(document.querySelectorAll('.nav-input'));
            const index = inputs.indexOf(active);
            
            if (index < inputs.length - 1) {
                inputs[index + 1].focus(); // Springe zum n√§chsten Feld
            } else {
                saveQuestion(); // Im letzten Feld (Textarea) wird gespeichert
            }
        }
    }
});

// 2. Nur A, B, C, D im Feld "correctOrder" erlauben
// Wir nutzen 'input', damit es bei jeder Tastatureingabe und auch beim Einf√ºgen pr√ºft
const orderInput = document.getElementById('correctOrder');
if (orderInput) {
    orderInput.addEventListener('input', function(e) {
        // Wandelt alles in Gro√übuchstaben um
        let value = this.value.toUpperCase();
        // L√∂scht alles, was kein A, B, C oder D ist
        this.value = value.replace(/[^A-D]/g, '');
    });
}

    // --- MASSENIMPORT LOGIK ---
let tempQuestions = []; // Speicher f√ºr die geladenen, aber noch nicht gespeicherten Fragen

function prepareImport() {
    const input = document.getElementById('massInput').value.trim();
    if (!input) return alert("Das Textfeld ist leer!");

    tempQuestions = [];
    // Trennung der Fragen anhand von Leerzeilen
    const blocks = input.split(/\n\s*\n/); 
    let errorLog = [];

    blocks.forEach((block, index) => {
        const lines = block.split('\n').map(l => l.trim()).filter(l => l.length > 0);
        if (lines.length < 6) return; // √úberspringe leere Bl√∂cke

        try {
            const q = {
                text: lines[0],
                options: {
                    A: lines.find(l => l.toUpperCase().startsWith('A:'))?.split(':')[1]?.trim(),
                    B: lines.find(l => l.toUpperCase().startsWith('B:'))?.split(':')[1]?.trim(),
                    C: lines.find(l => l.toUpperCase().startsWith('C:'))?.split(':')[1]?.trim(),
                    D: lines.find(l => l.toUpperCase().startsWith('D:'))?.split(':')[1]?.trim()
                },
                // Extrahiert nur die Buchstaben A-D aus der L√∂sungszeile
                answer: lines.find(l => l.toUpperCase().includes('REIHENFOLGE:'))?.split(':')[1]?.toUpperCase().replace(/[^A-D]/g, ''),
                explanation: lines.find(l => l.toUpperCase().startsWith('ERKL√ÑRUNG:'))?.split(':')[1]?.trim() || ""
            };

            // LOGIK-CHECK: Ist die Frage valide?
            if (!q.text || !q.options.A || !q.options.B || !q.options.C || !q.options.D || q.answer?.length !== 4) {
                throw new Error("Formatfehler");
            }
            tempQuestions.push(q);
        } catch (e) {
            errorLog.push(`Block ${index + 1}`);
        }
    });

    if (errorLog.length > 0) {
        alert("ACHTUNG: Folgende Bl√∂cke sind fehlerhaft und werden ignoriert:\n" + errorLog.join(", ") + "\n\nBitte pr√ºfe A:, B:, C:, D: und die REIHENFOLGE.");
    }

    if (tempQuestions.length === 0) return;

    // Vorschau im UI anzeigen
    const preview = document.getElementById('previewContent');
    preview.innerHTML = `<strong>Vorschau (${tempQuestions.length} Fragen bereit):</strong><hr style="border-color:#333">` + 
                        tempQuestions.map(q => `‚Ä¢ ${q.text.substring(0,40)}... <span style="color:var(--primary)">(${q.answer})</span>`).join('<br>');
    
    // UI-Elemente umschalten
    document.getElementById('importPreview').classList.remove('hidden');
    document.getElementById('confirmImportBtn').classList.remove('hidden');
    document.getElementById('cancelImportBtn').classList.remove('hidden');
    document.getElementById('previewBtn').classList.add('hidden');
}

async function executeImport() {
    let addedCount = 0;
    tempQuestions.forEach(newQ => {
        if (!questions.find(q => q.text === newQ.text)) {
            questions.push(newQ);
            addedCount++;
        }
    });

    if (addedCount > 0) {
        await saveToNpoint();
        alert(`${addedCount} Fragen hinzugef√ºgt!`);
    }
    
    cancelImport();
    showView('menu'); // Zur√ºck zum Hauptmen√º
}

function cancelImport() {
    tempQuestions = [];
    document.getElementById('importPreview').classList.add('hidden');
    document.getElementById('confirmImportBtn').classList.add('hidden');
    document.getElementById('cancelImportBtn').classList.add('hidden');
    document.getElementById('previewBtn').classList.remove('hidden');
    document.getElementById('massInput').value = "";
}

    function toggleMassMode(isMass) {
    document.getElementById('singleInputFields').classList.toggle('hidden', isMass);
    document.getElementById('massInputFields').classList.toggle('hidden', !isMass);
    document.getElementById('addTitle').innerText = isMass ? "Massenimport" : "Frage hinzuf√ºgen";
    if(!isMass) cancelImport(); // Setzt Massenimport-Felder zur√ºck
}

function closeAddView() {
    toggleMassMode(false); // Reset auf Einzelmodus f√ºr das n√§chste Mal
    showView('menu');
}

    loadData();
</script>
</body>
</html>
